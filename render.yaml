# This Blueprint defines all 11 services from the docker-compose.yml file.

# The region for all services in this Blueprint
# Must match for private network communication.


# --- DATABASE / CORE INFRASTRUCTURE SERVICES ---
# These services are internal (pserv) and require a persistent disk for data.
# changing to web as pserv is not supported for free plan
services:

# --- APPLICATION SERVICES (Custom Builds) ---
  
  # Frontend Web Service
  - type: web
    name: frontend
    runtime: docker
    region: oregon
    plan: free
    startCommand: nginx -g 'daemon off;'
    dockerContext: ./frontend
    dockerfilePath: ./frontend/Dockerfile
    # Only changes in 'frontend' folder will trigger a redeploy
    buildFilter:
      paths:
        - frontend/**
    envVars:
      - key: REACT_APP_GRAPHQL_URL
        value: https://graphql-gateway-ellp.onrender.com
      - key: REACT_APP_AUTH_URL
        value: https://authservice-q3x5.onrender.com
      - key: REACT_APP_CHATBOT_URL
        value: https://chatbot-hosm.onrender.com
      - key: REACT_APP_SPEECH_PARSER_URL
        value: https://ai-speech-parser.onrender.com
      - key: REACT_APP_ANALYTICS_URL
        value: https://analytics-g19c.onrender.com
      - key: REACT_APP_ACTIVITY_URL
        value: https://activity-tracking-lutk.onrender.com


  # GraphQL Gateway (Public API)
  - type: web
    name: graphql-gateway
    runtime: docker
    region: oregon
    plan: free
    dockerContext: ./graphql-gateway
    dockerfilePath: ./graphql-gateway/Dockerfile
    envVars:
      - key: PORT
        value: 10000
      - key: ACTIVITY_URL
        value: https://activity-tracking-lutk.onrender.com
      - key: ANALYTICS_URL
        value: https://analytics-g19c.onrender.com
      - key: CORS_ORIGINS
        value: https://frontend-56pg.onrender.com,http://localhost,http://localhost:3000,http://127.0.0
      - key: NODE_ENV
        value: development
      - key: JWT_SECRET
        sync: false
    buildFilter:
      paths:
        - graphql-gateway/**

  # Authentication Service (Public API)
  - type: web
    name: authservice
    runtime: docker
    region: oregon
    plan: free
    dockerContext: ./authservice
    dockerfilePath: ./authservice/Dockerfile
    envVars:
      - key: PORT
        value: 10000
      - key: SPRING_DATA_MONGODB_URI
        sync: false
      - key: SPRING_DATA_MONGODB_DATABASE
        sync: false
      - key: FRONTEND_URL
        sync: false
      - key: JWT_SECRET
        fromService:
          type: web
          name: graphql-gateway
          envVarKey: JWT_SECRET
    buildFilter:
      paths:
        - authservice/**

  # Activity Tracking Service (Private API)
  - type: web
    name: activity-tracking
    runtime: docker
    region: oregon
    plan: free
    dockerContext: ./activity-tracking
    dockerfilePath: ./activity-tracking/Dockerfile
    envVars:
      - key: PORT
        value: 10000
      - key: NODE_ENV
        value: development
      - key: JWT_SECRET
        fromService:
          type: web
          name: graphql-gateway
          envVarKey: JWT_SECRET
    buildFilter:
      paths:
        - activity-tracking/**

  # Analytics Service (Private API)
  - type: web
    name: analytics
    runtime: docker
    region: oregon
    plan: free
    dockerContext: ./analytics
    dockerfilePath: ./analytics/Dockerfile
    envVars:
      - key: PORT
        value: 10000
      - key: NODE_ENV
        value: development
      - key: MONGO_URI
        sync: false
      - key: MONGO_DB
        sync: false
      - key: JWT_SECRET_KEY
        fromService:
          type: web
          name: graphql-gateway
          envVarKey: JWT_SECRET
      - key: OPENAI_API_KEY
        fromService:
          type: web
          name: chatbot
          envVarKey: OPENAI_API_KEY
    buildFilter:
      paths:
        - analytics/**

  # Chatbot Service (Private API - Uses separate Dockerfile)
  - type: web
    name: chatbot
    runtime: docker
    region: oregon
    plan: free
    dockerContext: ./analytics # Context is ./analytics
    dockerfilePath: ./analytics/Dockerfile.chatbot # Use specific Dockerfile
    envVars:
      - key: PORT
        value: 10000
      - key: MONGO_URI
        fromService:
          type: web
          name: analytics
          envVarKey: MONGO_URI
      - key: MONGO_DB
        fromService:
          type: web
          name: analytics
          envVarKey: MONGO_DB
      - key: CHATBOT_PORT
        value: 5052
      - key: JWT_SECRET_KEY
        fromService:
          type: web
          name: graphql-gateway
          envVarKey: JWT_SECRET
      - key: OPENAI_API_KEY
        sync: false
    buildFilter:
      paths:
        - analytics/**

  # AI Speech Parser Service (Worker/Private API)
  - type: web
    name: ai-speech-parser
    runtime: docker
    region: oregon
    plan: free
    dockerContext: ./ai-speech-parser
    dockerfilePath: ./ai-speech-parser/Dockerfile
    envVars:
      - key: PORT
        value: 10000
      - key: GROQ_API_KEY
        sync: false
    buildFilter:
      paths:
        - ai-speech-parser/**