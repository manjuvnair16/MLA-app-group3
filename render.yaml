# This Blueprint defines all 11 services from the docker-compose.yml file.

# The region for all services in this Blueprint
# Must match for private network communication.


# --- DATABASE / CORE INFRASTRUCTURE SERVICES ---
# These services are internal (pserv) and require a persistent disk for data.
# changing to web as pserv is not supported for free plan
services:
  # MongoDB Database (Private Service with Disk)
  - type: web
    name: mongodb
    runtime: image
    image: 
      url: mnair16/mla-app-group3:latest
    region: oregon
    plan: free
    startCommand: mongod
    envVars:
      - key: PORT
        value: 27017
      - key: MONGO_INITDB_ROOT_USERNAME
        sync: false
      - key: MONGO_INITDB_ROOT_PASSWORD
        sync: false
      - key: MONGO_INITDB_DATABASE
        sync: false

# --- APPLICATION SERVICES (Custom Builds) ---
# These services are built from your source code using a Dockerfile.
  
  # Frontend Web Service
  - type: web
    name: frontend
    runtime: docker
    region: oregon
    plan: free
    startCommand: nginx -g 'daemon off;'
    dockerContext: ./frontend
    dockerfilePath: ./frontend/Dockerfile
    # Only changes in 'frontend' folder will trigger a redeploy
    buildFilter:
      paths:
        - frontend/**
    envVars:
      - key: PORT
        value: 80


  # GraphQL Gateway (Public API)
  - type: web
    name: graphql-gateway
    runtime: docker
    region: oregon
    plan: free
    dockerContext: ./graphql-gateway
    dockerfilePath: ./graphql-gateway/Dockerfile
    envVars:
      - key: port
        value: "4000"
      - key: ACTIVITY_URL
        value: http://activity-tracking:5300 # Uses internal service name
      - key: ANALYTICS_URL
        value: http://analytics:5050 # Uses internal service name 
      - key: CORS_ORIGINS
        value: http://localhost,http://localhost:3000,http://127.0.0
      - key: NODE_ENV
        value: development
      - key: JWT_SECRET
        sync: false
    buildFilter:
      paths:
        - graphql-gateway/**

  # Authentication Service (Public API)
  - type: web
    name: authservice
    runtime: docker
    region: oregon
    plan: free
    dockerContext: ./authservice
    dockerfilePath: ./authservice/Dockerfile
    envVars:
      - key: PORT
        value: 8080
      - key: SPRING_DATA_MONGODB_URI
        sync: false
      - key: SPRING_DATA_MONGODB_DATABASE
        sync: false
      - key: FRONTEND_URL
        sync: false
    buildFilter:
      paths:
        - authservice/**

  # Activity Tracking Service (Private API)
  - type: web
    name: activity-tracking
    runtime: docker
    region: oregon
    plan: free
    dockerContext: ./activity-tracking
    dockerfilePath: ./activity-tracking/Dockerfile
    envVars:
      - key: PORT
        value: 5300
      - key: NODE_ENV
        value: development
      - key: JWT_SECRET
        fromService:
          type: web
          name: graphql-gateway
          envVarKey: JWT_SECRET
    buildFilter:
      paths:
        - activity-tracking/**

  # Analytics Service (Private API)
  - type: web
    name: analytics
    runtime: docker
    region: oregon
    plan: free
    dockerContext: ./analytics
    dockerfilePath: ./analytics/Dockerfile
    envVars:
      - key: PORT
        value: 5050
      - key: NODE_ENV
        value: development
      - key: MONGO_URI
        sync: false
      - key: MONGO_DB
        sync: false
      - key: JWT_SECRET_KEY
        fromService:
          type: web
          name: graphql-gateway
          envVarKey: JWT_SECRET
      - key: OPENAI_API_KEY
        fromService:
          type: web
          name: chatbot
          envVarKey: OPENAI_API_KEY
    buildFilter:
      paths:
        - analytics/**

  # Chatbot Service (Private API - Uses separate Dockerfile)
  - type: web
    name: chatbot
    runtime: docker
    region: oregon
    plan: free
    dockerContext: ./analytics # Context is ./analytics
    dockerfilePath: ./analytics/Dockerfile.chatbot # Use specific Dockerfile
    envVars:
      - key: PORT
        value: 5052
      - key: MONGO_URI
        fromService:
          type: web
          name: analytics
          envVarKey: MONGO_URI
      - key: MONGO_DB
        fromService:
          type: web
          name: analytics
          envVarKey: MONGO_DB
      - key: CHATBOT_PORT
        value: 5052
      - key: JWT_SECRET_KEY
        fromService:
          type: web
          name: graphql-gateway
          envVarKey: JWT_SECRET
      - key: OPENAI_API_KEY
        sync: false
    buildFilter:
      paths:
        - analytics/**

  # AI Speech Parser Service (Worker/Private API)
  - type: web
    name: ai-speech-parser
    runtime: docker
    region: oregon
    plan: free
    dockerContext: ./ai-speech-parser
    dockerfilePath: ./ai-speech-parser/Dockerfile
    envVars:
      - key: PORT
        value: 5053
      - key: GROQ_API_KEY
        sync: false
    buildFilter:
      paths:
        - ai-speech-parser/**